<!--
## Edit poll questions and answers for each question.

Importanbt data attributes are data-action, data-section. These are both used for
command and simplify navigation in page.

PAGE_ Method documentation:
=========================

PAGE_Initialize - Main initialization function that sets up the page, creates draggable elements and configures listeners
PAGE_SetListeners - Configures event listeners for page interactions, handling actions like send and save
PAGE_RenderForm - Render UI elements for record
PAGE_Update - Update UI elements
PAGE_OnIdle - Handles idle state by updating UI elements and checking for changes
PAGE_ProcessResponse - Processes the response from the server and updates the UI accordingly

data-section documentation ====================================================

data-section="page" - Section for the page content.
data-section="poll-active" -  Section for the active poll.
data-section="question-list" - Container for the question list, questions are placed as a list where you can expand and see the answers.
data-section="answer-list" - Container for the answer list, answers are placed as a list where you can expand and see the details.

-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/variables-corporate-blue.css">
    <link rel="stylesheet" href="css/poll.css">
    <link rel="stylesheet" href="css/elements.css">
    <link rel="stylesheet" href="css/input-effects.css">
    <script src="js/gd_ui_toast.js"></script>
    <script src="js/gd_ui_tablelite.js"></script>
    <script src="js/gd_data_table.js"></script>
    <script src="js/gd_db.js"></script>
    <script src="js/gd_browser.js"></script>
    <title>Login - Web Vote</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
    </style>
</head>
<body class="page-box">
   <div data-section="page">
      <div data-section="poll-active"></div>
      <div data-section="question-list"></div>
   </div>

   <script>
   'use strict';

let oDocument_g;

// ## Initialize the page
document.addEventListener('DOMContentLoaded', function() {
   PAGE_SetListeners();
   PAGE_initialize();
});

function PAGE_initialize() {
   oDocument_g = new CDocument({});

   const ePollActive = oDocument_g.GetElement("poll-active");
   const eQuestionList = oDocument_g.GetElement("question-list");

   // ## Start idle timer - call PAGE_OnIdle() once per second ................
   CDocument.iIdleTimerId_s = setInterval(PAGE_OnIdle, 1000);

   // ## Prepare base url .....................................................
   const sBaseUrl = gd.GetBaseUrl();
   gd.SetBaseUrl(sBaseUrl);


   const fnRead = function(sName, oRecord) {
      const sTable = this.table;
      const eField = oDocument_g.GetElement("question-list").querySelector(`[data-field="${sName}"]`);
      if( eField ) { this.SetValue( sName, eField.value ); }
   };

   const fnWrite = function(sName, oRecord) {
      const sTable = this.table;
      const eField = oDocument_g.GetElement("question-list").querySelector(`[data-field="${sName}"]`);
      if( eField ) { eField.value = this.GetValue(sName); }
   };

   let oRecord = new DBRecord([], { fnRead, fnWrite });
   oRecord.table = "TPollQuestion";
   oRecord.AddColumn( aFieldQuestion, {sLabel: "label", sDescription: "description", sName: "field", sType: "type", bKey: "key"} );
   oDocument_g.AddRecord(oRecord);

   const eContainerQuestion = document.createElement('div');
   eContainerQuestion.dataset.table = "TPollQuestion";
   eContainerQuestion.dataset.section = "form";
   eContainerQuestion.classList.add('container-form');
   PAGE_RenderForm(eContainerQuestion, aFieldQuestion);
   PAGE_RenderCommands(eContainerQuestion, aButtonQuestionCommands, 'TPollQuestion');

   eQuestionList.appendChild(eContainerQuestion);

}

function PAGE_SetListeners() {
   const ePage = document.querySelector('[data-section="page"]'); // get page container that holds the complete page
   ePage.addEventListener("click", function(e_) {
      const eTarget = e_.target;
      if(!eTarget.dataset.action) return;                                      // If no action is defined, return
      const sAction = eTarget.dataset.action;
      debugger;

      // find closest dataset with table attribute
      const eClosest = eTarget.closest('[data-table]');
      const sTable = eClosest.dataset.table;                                                       console.assert( sTable );
      const oDBRecord = oDocument_g.GetRecord( sTable );                                           console.assert( oDBRecord, "oDBRecord is null" );

      oDBRecord.ReadValues();
      console.log( oDBRecord.AsJson() );

      switch( sAction ) {
         case 'insert': {
            const oRecord = { table: sTable, values: oDBRecord.GetAllValues() };
            const sRecord = JSON.stringify(oRecord);
            const sArguments = `record=${sRecord}`;
            gd.SendToServer("", "!db/insert?echo=user", sArguments).then(function(oResult) {
               PAGE_ProcessResponse(oResult, "question");
            });

         } break;
         case 'delete':
            oDBRecord.Delete();
            PAGE_RenderList(eQuestionList, 'TPollQuestion');
            break;
         default:
            console.error(`Unknown action: ${sAction}`);
      }
   });
}

/** ---------------------------------------------------------------------------
 *
 */
function PAGE_RenderForm( eContainer, aFields ) {
   // ## Prepare fields to set where new row is created .......................
   let bCols = false;
   aFields.forEach(oField => {
      if( !oField.label ) return;
      if( !oField.cols || bCols === false ) { oField.bRow = true; }

      if( oField.cols ) { bCols = true }
      else { bCols = false }
   });

   // print fields
   console.log(aFields);

   aFields.forEach(oField => {
      if( !oField.label ) return;

      // ## Prepare row for field .............................................
      let eDivRow;
      if(oField.bRow) {
         eDivRow = document.createElement('div');
         eDivRow.className = 'grid-row';
         if(oField.cols) { eDivRow.classList.add(`cols-${oField.cols}`); }
         eDivRow.style.marginTop = '20px';
         eContainer.appendChild(eDivRow);
      }
      else { eDivRow = eContainer.lastElementChild; }

      // ## Prepare label for field ...........................................
      const eLabel = document.createElement('label');
      eLabel.className = 'floating';

      // ### Add span class if span is defined
      if( oField.span ) { eLabel.classList.add(`col-span-${oField.span}`); }



      let sTagName = "input";
      let sType = oField.type;
      if( sType === "text" ) { sTagName = "textarea"; }
      const eInput = document.createElement(sTagName);
      if( sType === "text" ) { eInput.rows = 3; }
      else { eInput.type = oField.input || 'text'; }
      eInput.placeholder = ' ';
      eInput.required = oField.required;
      eInput.dataset.field = oField.field;

      // ## Prepare label for field ...........................................
      const eSpan = document.createElement('span');
      eSpan.textContent = oField.label;

      eLabel.appendChild(eInput);
      eLabel.appendChild(eSpan);
      eDivRow.appendChild(eLabel);
   });
}

/** ---------------------------------------------------------------------------
 * Render command buttons at bottom of form using metadata array
 * @param {HTMLElement} eContainer - Container to add buttons to
 * @param {Array} aButtons - Array of button metadata objects
 * @param {string} sTable - Table name for record operations
 */
function PAGE_RenderCommands( eContainer, aButtons, sTable ) {
   // ## Create command row .................................................
   const eCommandRow = document.createElement('div');
   eCommandRow.className = 'row right';
   eCommandRow.style.marginTop = '24px';
   eCommandRow.style.borderTop = '1px solid var(--color-border)';
   eCommandRow.style.paddingTop = '20px';

   // ## Render buttons from metadata array ....................................
   aButtons.forEach(oButton => {
      const eButton = document.createElement('button');
      eButton.className = oButton.className || 'button';
      eButton.textContent = oButton.label;
      eButton.dataset.action = oButton.action;
      eCommandRow.appendChild(eButton);
   });

   eContainer.appendChild(eCommandRow);
}

/** --------------------------------------------------------------------- @API [tag: onidle]
 * Handles idle state by updating UI elements and checking for changes
 */
const PAGE_OnIdle = (function() {
  var bLastModified = false;

  return function() {
     const bModified = oDocument_g.IsModified();

     if( bModified !== bLastModified ) {

        bLastModified = bModified;
     }
  }
})();


class CDocument {

   static iIdleTimerId_s = null; // Global timer ID for idle callback

   constructor( oOptions = {} ) {
      this.bModified = false; // Initialize modified flag to false
      this.oElement = {};     // Cache for DOM elements
      this.aRecords = [];    // Initialize records array to empty, holds DBRecord objects
      this.aTable = []; // Initialize table array to empty, holds Table objects
   }

   // Check if document has been modified ------------------------------
   IsModified() { return this.bModified; }
   // Set modified flag to true or false -------------------------------
   SetModified(bModified) { this.bModified = bModified; }

   // Get DOM element by name ------------------------------------------
   GetElement(sName) {
      if(!this.oElement[sName]) { this.oElement[sName] = document.querySelector(`[data-section="${sName}"]`); }
      return this.oElement[sName];
   }

   // Add a record to the document --------------------------------------------
   AddRecord(oRecord) { this.aRecords.push(oRecord); }

   // Get a record by table name ----------------------------------------------
   GetRecord( sTable ) {
      return this.aRecords.find(oRecord => oRecord.table === sTable);
   }

   AddTable( oTable ) { this.aTable.push(oTable); }

   GetTable( sTable ) {
      return this.aTable.find(oTable => oTable.name === sTable);
   }

}

const aFieldQuestion = [
   { field: "PollQuestionK", type: "string", key: true },
   { label: "Name", description: "Name for question", field: "FName", type: "string", required: true, cols:3, span: 2 },
   { label: "Label", description: "Label", field: "FLabel", type: "string", required: false, cols: true },
   { label: "Description", description: "Explanation for question", field: "FDescription", type: "text", required: false }
];

// Button command metadata array for question form
const aButtonQuestionCommands = [
   { label: "Add", action: "insert", className: "button button-success" },
   { label: "Update", action: "Update", className: "button button-warning" },
   { label: "Delete", action: "Delete", className: "button button-danger" },
   { label: "Save", action: "Save", className: "button" },
   { label: "Cancel", action: "Cancel", className: "button button-secondary" }
];



   </script>
</body>
</html>
