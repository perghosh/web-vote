<!--
PAGE_ Method Documentation:
=========================

PAGE_Initialize - Main initialization function that sets up the page, creates draggable elements and configures listeners
PAGE_GenerateEditFields - Generates edit fields for the page
PAGE_SetListeners - Configures event listeners for page interactions, handling actions like send and save
PAGE_Update - Update UI elements
PAGE_OnIdle - Handles idle state by updating UI elements and checking for changes


@TODO [tag: TUser, update] [description: update user]
@TODO [tag: TUser, delete] [description: delete user]

-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/variables-corporate-blue.css">
    <link rel="stylesheet" href="css/elements.css">
    <link rel="stylesheet" href="css/input-effects.css">
    <script src="js/gd_ui_toast.js"></script>
    <script src="js/gd_db.js"></script>
    <script src="js/gd_browser.js"></script>
    <title>Login - Web Vote</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* Container needs to be a visible card */
        /*.page-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 800px;
        }*/
    </style>
</head>
<body>
    <div id="idPage" class="page-container" data-section="container">

        <form id="idUser" class="container-form" onsubmit="event.preventDefault();" style="width: 500px;">
           <div data-section="field"></div>
           <div class="row" data-section="command" style="justify-content: flex-end;">
               <button class="button" data-action="add">Save as new user</button>
               <button class="button" style="visibility: hidden;" data-action="update" data-idle="user_key">Update</button>
               <button class="button" style="visibility: hidden;" data-action="delete" data-idle="user_key">Delete</button>
           </div>
        </form>

    </div>

    <script>
    'use strict';

const aEditField = [
   { label: "Alias", description: "Alias for user in system", field: "FAlias", type: "string", required: true },
   { label: "User name", description: "Name for user in system", field: "FName", type: "string", required: true },
   { label: "Email", description: "Email for user in system", field: "FMail", type: "string", required: true },
   { label: "Password", description: "Password for user in system", field: "FPassword", type: "string", required: true, input: "password", pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{8,}$" },
   { label: "Display Name", description: "Name for user in system", field: "FDisplayName", type: "string" },
   { label: "Login name", description: "Login name for user in system", field: "FLoginName", type: "string" }
];

let oToast_g;
let oDocument_g;


document.addEventListener('DOMContentLoaded', function() {
   console.log('Login page loaded successfully!');
   PAGE_initialize();
});

/** --------------------------------------------------------------------------
 * Initialize edit user page
 */
function PAGE_initialize() {
   console.log('Initializing edit user page...');

   // Initialize document object
   oDocument_g = new CDocument;
   let oRecord = new DBRecord({sName: "UserK", bKey: true}, "TUser" );

   oRecord.AddColumn( {sLabel: "label", sDescription: "description", sName: "field-name", sType: "string"} );
   oRecord.AddColumn( aEditField, {sLabel: "label", sDescription: "description", sName: "field", sType: "type"} );
   oRecord.AddColumn( aEditField, "sLabel,label;sDescription,description;sName,field;sType,type" );


   oDocument_g.AddRecord(oRecord);

   // ## Generate input form for user .........................................
   const eForm = document.getElementById('idUser').querySelector('div[data-section="field"]');
   PAGE_GenerateEditFields(eForm, aEditField);

   // ## Configure toast ............................................
   oToast_g = new UIToast(document.body, { sPosition: 'top-right', iDuration: 3000 });

   // ## Prepare base url .....................................................
   const sBaseUrl = gd.GetBaseUrl();
   gd.SetBaseUrl(sBaseUrl);

   // ## Set listeners ........................................................
   PAGE_SetListeners();

   // ## Start idle timer - call PAGE_OnIdle() once per second
   CDocument.iIdleTimerId_s = setInterval(PAGE_OnIdle, 1000);

   const sInsert = "INSERT INTO TUser (ContainerK, FAlias, FMail, FPassword, FDisplayName, FLoginName) VALUES (1,{FAlias}, {FMail}, {FPassword}, {FDisplayName}, {FLoginName}) RETURNING UserK AS 'key', 'TUser' AS 'table'";
   const sArguments = `query=${sInsert}` + "\n" + `name=user-add`
   gd.SendToServer("", "!sys/meta/query/add?format=jinja&type=select", sArguments).then(function(oResult) {
      PAGE_ProcessResponse(oResult, "meta");
   });

}

/** ---------------------------------------------------------------------------
 * Generates edit fields for the page
 */
function PAGE_GenerateEditFields( eContainer, aEditField ) {
   aEditField.forEach(oField => {
      const div = document.createElement('div');
      div.className = 'group';
      div.style.marginTop = '20px';

      const label = document.createElement('label');
      label.className = 'floating';

      const eInput = document.createElement('input');
      eInput.type = oField.input || 'text';
      eInput.placeholder = ' ';
      eInput.required = oField.required;
      //if( oField.pattern ) { eInput.pattern = oField.pattern; }
      eInput.dataset.field = oField.field;

      // generate random value
      eInput.value = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);

      const eSpan = document.createElement('span');
      eSpan.textContent = oField.label;

      label.appendChild(eInput);
      label.appendChild(eSpan);
      div.appendChild(label);
      eContainer.appendChild(div);
   });
}

/** --------------------------------------------------------------------- @API [tag: event, command]
 * Configure page listeners, handle page specific events
 */
function PAGE_SetListeners() {

   // ## Initialize page work area listener .............................

   const eUserContainer = document.getElementById('idUser');
   eUserContainer.addEventListener("click", function(e_) {
      const eTarget = e_.target;
      if(!eTarget.dataset.action) return;                             // If no action is defined, return
      e_.stopPropagation();
      const eContainer = eTarget.closest('[data-section="container"]');

      // ## Collect values from elements with attribute 'data-field'
      const aFields = eContainer.querySelectorAll('[data-field]');
      const oFields = {};
      aFields.forEach(function(eField) {
         const sField = eField.dataset.field;
         const sValue = eField.value;
         oFields[sField] = sValue;
      });

      const sAction = eTarget.dataset.action;
      switch(sAction) {
         case "add": {                                                 // send command to wed server
            const sInsert = "INSERT INTO TUser (ContainerK, FAlias, FMail, FPassword, FDisplayName, FLoginName) VALUES (1,{FAlias}, {FMail}, {FPassword}, {FDisplayName}, {FLoginName}) RETURNING UserK AS 'key', 'TUser' AS 'table'";
            const sSelect = "SELECT * FROM TUser WHERE UserK = x''{::key}''";
            const sValues = JSON.stringify(oFields);
            const sArguments = `query=${sInsert}` + "\n" + `values=${sValues}` + "\n" + `query=${sSelect}`;

            oToast_g.Show('Skickar!');

            gd.SendToServer("", "!db/insert/ask?echo=user", sArguments).then(function(oResult) {
               PAGE_ProcessResponse(oResult, "user");
            });
         } break;
         case "update": {                                                  // save command
            const sUpdate = "UPDATE TUser SET FAlias = {FAlias}, FMail = {FMail}, FPassword = {FPassword}, FDisplayName = {FDisplayName}, FLoginName = {FLoginName} WHERE UserK = x''{::key}''";
            const sValues = JSON.stringify(oFields);
            const sArguments = `query=${sUpdate}` + "\n" + `values=${sValues}`;

            oToast_g.Show('Update user ' + oFields.FAlias);

            gd.SendToServer("", "!db/update/ask?echo=user", sArguments).then(function(oResult) {
               PAGE_ProcessResponse(oResult, "user");
            });
         } break;
         default:
            console.error("Unknown action:", sAction);
      }
   });
}

/** ---------------------------------------------------------------------
 * Handle response data from server and display it in the container
 *
 * Response data format is { type: <format>, data: <data> } and type can be any of
 * json, xml or text. "type" is the format of the data, e.g. "json", "xml", "text"
 *
 * @param {object} oData - The response data to process, format is { type: <format>, data: <data> }
 * @param {string} sOperation - The operation that was performed
 */
function PAGE_ProcessResponse(oData, sOperation) {
   let sResult = '';
   let eResults = null; // results element from xml responses with results/result format

   switch(oData.type) {
      case 'json':
         sResult = JSON.stringify(oData.data, null, 2);
         break;
      case 'xml':
         // If oData.data is an XML Document object, serialize it to string
         if (oData.data instanceof XMLDocument || oData.data.nodeType === 9) {
            //sResult = (new XMLSerializer()).serializeToString(oData.data);

            // ## query results element
            eResults = oData.data.querySelector('results');                   // get results element holding result elements
         } else {
            // If it's already a string, use it directly
            sResult = oData.data;
         }
         break;
      case 'text':
         sResult = oData.data;
         break;
      default:
         console.error("Unknown response type:", oData.type);
   }

   if( eResults ) {
      if( sOperation === "meta" ) {

      }
      else if( sOperation === "user" ) {

         // ## Extract the generated user key
         const eInsert = eResults.querySelector('result[command="insert"]');
         const oUser = JSON.parse( eInsert.textContent );
         const oDBRecord = oDocument_g.GetRecord( oUser.table );                                      console.assert( oDBRecord, "oDBRecord is null" );
         oDBRecord.SetKeyValue( oUser.key );

         const aAsk = eResults.querySelectorAll('result[command="ask"]');

         // parse content to json object
         const oContent = JSON.parse(aAsk[0].textContent);

         const sMessage = "AnvÃ¤ndare skapad med alias: " + oContent.FAlias;
         oToast_g.Show(sMessage, {sType: "info", iDuration: 10000, minWidth: "600px"});
         PAGE_Update();
      }
      else {
         console.assert( false, "sOperation is unknown" );
      }
   }
}

/** ---------------------------------------------------------------------------
 * Update UI elements
 */
function PAGE_Update() {
   // ## Updaate based on DBRecord for TUser holds key value or not
   const oDBRecordUser = oDocument_g.GetRecord( "TUser" );
   const bUserHasKey = oDBRecordUser.HasKeyValue();

   const eUser = document.getElementById("idUser");

   const aUserButtons = eUser.querySelectorAll("[data-idle='user_key']");

   if( bUserHasKey === true ) {
      aUserButtons.forEach( eButton => {
         eButton.style.visibility = "visible";
      });
   } else {
      aUserButtons.forEach( eButton => {
         eButton.style.visibility = "hidden";
      });
   }
}





/** -------------------------------------------------------------------------- @API [tag: onidle]
 * Handles idle state by updating UI elements and checking for changes
 */
const PAGE_OnIdle = (function() {
   var bLastModified = false;

   return function() {
      const bModified = oDocument_g.IsModified();

      if( bModified !== bLastModified ) {
         PAGE_Update();

         bLastModified = bModified;
      }
   }
})();


class CDocument {

   static iIdleTimerId_s = null; // Global timer ID for idle callback

   constructor( oOptions = {} ) {
      this.bModified = false; // Initialize modified flag to false
      this.aRecords = [];
   }

   // Check if document has been modified ------------------------------
   IsModified() { return this.bModified; }
   // Set modified flag to true or false -------------------------------
   SetModified(bModified) { this.bModified = bModified; }

   // Add a record to the document -------------------------------------
   AddRecord(oRecord) {
      this.aRecords.push(oRecord);
   }

   GetRecord( sTable ) {
      return this.aRecords.find(oRecord => oRecord.table === sTable);
   }
}
    </script>
</body>
</html>
